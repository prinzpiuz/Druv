name: Infra Services
services:
  dockerproxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: dockerproxy
    pull_policy: always
    environment:
      - CONTAINERS=1
      - SERVICES=1
      - TASKS=1
      - POST=0
    ports:
      - 127.0.0.1:2375:2375
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - ${NETWORK_NAME}
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    pull_policy: always
    environment:
      PUID: 1000
      PGID: 1000
      HOMEPAGE_ALLOWED_HOSTS: "*"
      HOMEPAGE_VAR_TAILSCALE_API_KEY: ${HOMEPAGE_VAR_TAILSCALE_API_KEY}
      HOMEPAGE_VAR_PORTAINER_API_KEY: ${HOMEPAGE_VAR_PORTAINER_API_KEY}
      HOMEPAGE_VAR_RADARR_API_KEY: ${HOMEPAGE_VAR_RADARR_API_KEY}
      HOMEPAGE_VAR_SONARR_API_KEY: ${HOMEPAGE_VAR_SONARR_API_KEY}
      HOMEPAGE_VAR_READARR_API_KEY: ${HOMEPAGE_VAR_READARR_API_KEY}
      HOMEPAGE_VAR_AUDIOBOOKSHELF_API_KEY: ${HOMEPAGE_VAR_AUDIOBOOKSHELF_API_KEY}
      HOMEPAGE_VAR_PROWLARR_API_KEY: ${HOMEPAGE_VAR_PROWLARR_API_KEY}
      HOMEPAGE_VAR_JACKETT_API_KEY: ${HOMEPAGE_VAR_JACKETT_API_KEY}
      HOMEPAGE_VAR_QBITTORRENT_USERNAME: ${HOMEPAGE_VAR_QBITTORRENT_USERNAME}
      HOMEPAGE_VAR_QBITTORRENT_PASSWORD: ${HOMEPAGE_VAR_QBITTORRENT_PASSWORD}
      HOMEPAGE_VAR_BAZARR_API_KEY: ${HOMEPAGE_VAR_BAZARR_API_KEY}
      HOMEPAGE_VAR_RESTIC_PASSWORD: ${HOMEPAGE_VAR_RESTIC_PASSWORD}
      HOMEPAGE_VAR_RESTIC_USERNAME: ${HOMEPAGE_VAR_RESTIC_USERNAME}
      HOMEPAGE_VAR_LIDARR_API_KEY: ${HOMEPAGE_VAR_LIDARR_API_KEY}
      HOMEPAGE_VAR_BESZEL_USERNAME: ${HOMEPAGE_VAR_BESZEL_USERNAME}
      HOMEPAGE_VAR_BESZEL_PASSWORD: ${HOMEPAGE_VAR_BESZEL_PASSWORD}
    ports:
      - 3000:3000
    volumes:
      - ./configs/homepage:/app/config
    restart: always
    env_file:
      - .env
    networks:
      - ${NETWORK_NAME}
  myspeed:
    image: germannewsmaker/myspeed
    container_name: mySpeed
    pull_policy: always
    volumes:
      - /configs/myspeed:/myspeed/data
    restart: always
    network_mode: service:gluetun
    env_file:
      - .env
    depends_on:
      gluetun:
        condition: service_healthy
  myspeed_no_vpn:
    image: germannewsmaker/myspeed
    container_name: mySpeedNoVPN
    pull_policy: always
    volumes:
      - /configs/myspeed_no_vpn:/myspeed/data
    restart: always
    network_mode: bridge
    ports:
      - 5217:5216
    env_file:
      - .env
  beszel-agent:
    image: henrygd/beszel-agent:alpine
    container_name: beszel-homelab-agent
    restart: unless-stopped
    pull_policy: always
    network_mode: host
    volumes:
      - /configs/beszel_agent_data:/var/lib/beszel-agent
      - /configs/beszel_socket:/beszel_socket
      - /var/run/docker.sock:/var/run/docker.sock:ro
    env_file:
      - .env
    cap_add:
      - SYS_RAWIO
      - SYS_ADMIN
      - CAP_PERFMON
    devices:
      - /dev/sda:/dev/sda
      - /dev/sdb:/dev/sdb
      - /dev/dri/card0:/dev/dri/card0
    environment:
      - LISTEN=/beszel_socket/beszel.sock
      - HUB_URL=http://localhost:8090
      - TOKEN=${BESZEL_TOKEN}
      - KEY=${BESZEL_KEY}
      - INTEL_GPU_DEVICES=/dev/dri/card0
      - SMART_DEVICES=/dev/sdb:sat,/dev/sda:sat
      - EXTRA_FILESYSTEMS=sdb
networks:
  default:
    name: ${NETWORK_NAME}
    external: true
